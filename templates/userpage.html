<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tourism Malaysia</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #fafbff;
      color: #222;
      scroll-behavior: smooth;
    }
    :root { --navbar-height: 40px; }
    .navbar {
      height: var(--navbar-height);
      display: flex;
      align-items: center;
      padding: 12px 24px;
      background: #fff;
      border-bottom: 1px solid #eee;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      padding-right: 40px;
    }
    .auth-buttons { margin-right: 28px; }
    .logo { height: 32px; margin-right: 16px; cursor: pointer; }
    .nav-item, .dropdown-btn {
      display: flex;
      align-items: center;
      padding: 8px 14px;
      border-radius: 20px;
      margin-right: 8px;
      text-decoration: none;
      color: #003087;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.18s;
      position: relative;
    }
    .nav-icon { height: 28px; width: 28px; margin-right: 8px; object-fit: contain; }
    .nav-item:hover, .dropdown-btn:hover, .dropdown-content a:hover { background-color: #e6f0ff; }
    .spacer { flex-grow: 1; }
    .auth-buttons a {
      padding: 10px 20px;
      margin-left: 10px;
      border-radius: 24px;
      text-decoration: none;
      font-weight: bold;
    }
    .login { border: 2px solid #003087; color: #003087; background: #fff; }
    .signup { background: #003087; color: #fff; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: #fff;
      min-width: 180px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1200;
      padding: 6px 0;
    }
    .dropdown-content a {
      color: #003087;
      padding: 12px 14px;
      text-decoration: none;
      display: flex;
      align-items: center;
      border-radius: 8px;
      transition: background 0.13s;
      font-weight: bold;
      white-space: nowrap;
    }
    .dropdown.show .dropdown-content { display: block; }
    .hero {
      margin-top: var(--navbar-height);
      height: 65vh;
      min-height: 340px;
      background-size: cover;
      background-position: center center;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
    }
    .hero-content {
      background: rgba(0,0,0,0.54);
      color: #fff;
      padding: 60px 36px 30px 36px;
      margin: 24px;
      border-radius: 20px;
      font-size: 2rem;
      font-weight: 700;
      text-align: right;
    }
    @media (max-width: 900px) {
      :root { --navbar-height: 54px; }
      .hero-content { padding-top: 36px; }
    }
    section { padding: 60px 0 40px 0; background: #f5f6fb; }
    .section-title { font-size: 2rem; font-weight: bold; margin: 0 0 22px 6vw; }
    .card-container {
      display: flex;
      gap: 24px;
      overflow-x: auto;
      padding: 0 6vw;
    }
    .card {
      background: #fff;
      border-radius: 18px;
      width: 260px;
      min-width: 260px;
      height: 350px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      display: flex;
      flex-direction: column;
      transition: transform 0.18s;
      position: relative;
    }
    .card:hover { transform: translateY(-8px) scale(1.025);}
    .card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 18px 18px 0 0;
    }
    .banner {
      font-weight: bold;
      font-size: 1.18rem;
      margin: 16px 18px 8px 18px;
      flex: none;
      color: #003087;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    .description {
      margin: 0 18px 14px 18px;
      color: #444;
      font-size: 0.98rem;
      flex: 1 1 auto;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card.more-card {
      background: #003087;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: 600;
      min-width: 160px;
      height: 350px;
      border-radius: 18px;
      cursor: pointer;
    }
    @media (max-width: 900px) {
      .card { width: 85vw; min-width: 85vw; }
      .hero-content { font-size: 1.2rem; padding: 14px 10px; }
    }

  .hero-bg {
    background-image: url('{{ url_for('static', filename='images/sibu_central_night.jpg') }}');
  }

    /* ---- FLOATING CHATBOT STYLES ---- */
    #chatbot-float-btn {
      position: fixed; bottom: 32px; right: 32px;
      width: 56px; height: 56px;
      aspect-ratio: 1/1;
      background: transparent;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 16px rgba(21,76,121,0.14);
      z-index: 5000;
      cursor: grab;
      border: none;
      padding: 0;
      transition: box-shadow 0.13s;
      user-select: none;
    }
    #chatbot-float-btn img {
      width: 40px; height: 40px; display: block; pointer-events: none;
    }
    #chatbot-window {
      position: fixed;
      width: 320px; max-width: 96vw; height: 470px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(21,76,121,0.18);
      z-index: 5001;
      display: none;
      flex-direction: column;
      overflow: hidden;
      transition: left 0.16s, right 0.16s, top 0.16s, bottom 0.16s;
    }
    .draggable-bar {
      width: 100%; height: 36px; background: #154c79;
      cursor: move; display: flex; align-items: center; justify-content: space-between; color: #fff; padding: 0 12px;
    }
    .draggable-title { font-weight: bold; font-size: 16px; }
    .draggable-close {
      background: none; border: none; color: #fff; font-size: 22px;
      cursor: pointer; line-height: 1;
    }
    #chatbot-messages-widget {
      flex: 1;
      overflow-y: auto;
      padding: 56px 0 90px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #fff;
    }
    .message-row {
      display: flex; align-items: flex-end; margin: 0 16px;
    }
    .message-row.self { justify-content: flex-end; }
    .message-row.assistant { justify-content: flex-start; }
    .profile-pic {
      width: 32px; height: 32px; border-radius: 50%; margin: 0 8px;
      object-fit: cover; background: #eee; border: 1px solid #ddd;
    }
    .chat-bubble {
      max-width: 68vw;
      padding: 10px 16px;
      border-radius: 18px 18px 6px 18px;
      background: #f1f1f1; color: #222;
      font-size: 15px; margin-bottom: 2px;
      word-break: break-word;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .self .chat-bubble {
      background: #d4ecff; color: #154c79;
      border-radius: 18px 18px 18px 6px;
      margin-left: 32px;
    }
    .assistant .chat-bubble {
      background: #f6f7fb; color: #252525;
      border-radius: 18px 18px 6px 18px;
      margin-right: 32px;
    }
    #chatbot-input-area-widget {
      background: #fafbfc;
      padding: 13px 0;
      width: 100%;
      position: absolute;
      bottom: 0; left: 0;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      border-top: 1px solid #ececec;
    }
    #chatbot-input-area-widget input {
      background: transparent; border: none; outline: none; color: #222;
      font-size: 15px; flex: 1; padding: 10px 0;
    }
    #chatbot-input-area-widget button {
      background: #154c79; border: none; border-radius: 50%; width: 32px; height: 32px; margin-left: 10px;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    #chatbot-input-area-widget button svg { fill: #fff; width: 16px; height: 16px; }
    .clear-chat-btn-widget {
      position: absolute; top: 42px; right: 16px; padding: 6px 12px;
      border: 2px solid #003087; background: #fff; color: #003087;
      border-radius: 5px; font-size: 13px; cursor: pointer;
      font-weight: bold; transition: background 0.14s, color 0.14s;
    }
    .clear-chat-btn-widget:hover { background: #003087; color: #fff; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <a href="#" class="nav-item" style="padding-left:0;">
      <img src="{{ url_for('static', filename='images/swan.png') }}" alt="Sibu" class="logo">
      Sibu
    </a>
    <a href="#section-cuisine" class="nav-item">
      <img src="{{ url_for('static', filename='images/cuisines.png') }}" alt="Cuisine" class="nav-icon">Cuisines
    </a>
    <a href="#section-shopping" class="nav-item">
      <img src="{{ url_for('static', filename='images/shopping.png') }}" alt="Shopping" class="nav-icon">Shopping
    </a>
    <a href="#section-attractions" class="nav-item">
      <img src="{{ url_for('static', filename='images/attractions.png') }}" alt="Attractions" class="nav-icon">Attractions
    </a>
    <a href="#section-accomodation" class="nav-item">
      <img src="{{ url_for('static', filename='images/hotel.png') }}" alt="Accomodation" class="nav-icon">Accomodation
    </a>
    <div class="dropdown">
      <button class="dropdown-btn" id="moreDropdown">
        More <span style="margin-left:6px;">&#x25BC;</span>
      </button>
      <div class="dropdown-content">
        <a href="#section-entertainment">
          <img src="{{ url_for('static', filename='images/entertainment.png') }}" alt="Entertainment" class="nav-icon">Entertainment
        </a>
        <a href="#section-transport">
          <img src="{{ url_for('static', filename='images/transport.png') }}" alt="Transport" class="nav-icon">Transport
        </a>
        <a href="#section-services">
          <img src="{{ url_for('static', filename='images/services.png') }}" alt="Services" class="nav-icon">Services
        </a>
        <a href="#section-religion">
          <img src="{{ url_for('static', filename='images/religion.png') }}" alt="Religion" class="nav-icon">Religion
        </a>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="auth-buttons">
      <a href="{{ url_for('chatbot_page') }}" class="login">AI Assistant</a>
      <a href="{{ url_for('account_page') }}" class="signup">Me</a>
    </div>
  </div>
  <!-- Hero Section -->
  <section class="hero" id="hero"
    style="background-image: url('{{ url_for('static', filename='images/sibu_central_night.jpg') }}');">
    <div class="hero-content">
      <h1>------</h1>
      <h1>Welcome to</h1>
      <h1>Town of Swan</h1>
      <h1>Sibu, Sarawak</h1>
    </div>
  </section>
  <!-- Sections -->
  <section id="section-cuisine">
    <div class="section-title">Cuisine</div>
    <div class="card-container" id="cuisine-cards"></div>
  </section>
  <section id="section-shopping">
    <div class="section-title">Shopping</div>
    <div class="card-container" id="shopping-cards"></div>
  </section>
  <section id="section-attractions">
    <div class="section-title">Attractions</div>
    <div class="card-container" id="attractions-cards"></div>
  </section>
  <section id="section-accomodation">
    <div class="section-title">Accomodation</div>
    <div class="card-container" id="accomodation-cards"></div>
  </section>
  <section id="section-entertainment">
    <div class="section-title">Entertainment</div>
    <div class="card-container" id="entertainment-cards"></div>
  </section>
  <section id="section-transport">
    <div class="section-title">Transport</div>
    <div class="card-container" id="transport-cards"></div>
  </section>
  <section id="section-services">
    <div class="section-title">Services</div>
    <div class="card-container" id="services-cards"></div>
  </section>
  <section id="section-religion">
    <div class="section-title">Religion</div>
    <div class="card-container" id="religion-cards"></div>
  </section>
  <!-- Floating Chatbot Button & Widget (SINGLE DEFINITION) -->
  <button id="chatbot-float-btn" title="Open AI Assistant">
    <img src="{{ url_for('static', filename='images/chatbot_btn.png') }}" alt="chatbot">
  </button>
  <div id="chatbot-window">
    <div class="draggable-bar">
      <span class="draggable-title">AI Assistant</span>
      <button class="draggable-close" onclick="toggleChatbotWindow()" title="Close">&times;</button>
    </div>
    <div style="padding:10px 0 0 0; font-size:15px; text-align:center; font-weight:bold; color:#2a2a2a;">
      Tourism Chatbot
    </div>
    <button class="clear-chat-btn-widget" onclick="confirmClearChat()">Clear</button>
    <div id="chatbot-messages-widget"></div>
    <form id="chatbot-input-area-widget" autocomplete="off" onsubmit="return sendWidgetMessage();">
      <div style="display:flex;align-items:center;background:#f6f6f6;border-radius:999px;padding:0 16px;width:82%;max-width:500px;min-width:120px;box-shadow:0 2px 8px rgba(0,0,0,0.06);border:1px solid #ececec;">
        <input type="text" placeholder="Message..." id="widget-msg" autocomplete="off" />
        <button type="submit"><svg viewBox="0 0 24 24"><path d="M2 21l21-9-21-9v7l15 2-15 2z"/></svg></button>
      </div>
    </form>
  </div>
  <!-- Main scripts -->
  <script>
  // === Navigation & Section Scroll ===
  document.querySelectorAll('.nav-item, .dropdown-content a').forEach(item => {
  item.addEventListener('click', function(event) {
    const sectionId = this.getAttribute('href');
    if (sectionId === "#") {
      event.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
      document.querySelector('.dropdown').classList.remove('show');
      return;
    }
    if (sectionId && sectionId.startsWith('#')) {
      event.preventDefault();
      document.querySelector(sectionId).scrollIntoView({ behavior: 'smooth' });
      document.querySelector('.dropdown').classList.remove('show');
    }
  });
});
// ========== DROPDOWN SHOW/HIDE ==========
document.getElementById('moreDropdown').addEventListener('click', function(event) {
  event.stopPropagation();
  const dropdown = this.parentElement;
  dropdown.classList.toggle('show');
});
document.body.addEventListener('click', function() {
  document.querySelector('.dropdown').classList.remove('show');
});

// ========== UTILITY: Slugify (MUST match Flask logic) ==========
function slugify(text) {
  return text.toLowerCase()
    .normalize('NFKD').replace(/[^\w\s-]/g, '') // remove special unicode
    .replace(/'/g, '')
    .replace(/&/g, 'and')
    .replace(/\(|\)/g, '')
    .replace(/\//g, '-')
    .replace(/\./g, '')
    .replace(/,/g, '')
    .replace(/\s+/g, '-');
}

// ========== SECTIONS DATA ==========
const FLASK_ROUTES = {
  cuisine: "/cuisines",
  shopping: "/shopping",
  attractions: "/attractions",
  accomodation: "/accomodation",
  entertainment: "/entertainment",
  transport: "/transport",
  services: "/services",
  religion: "/religion"
};

const SECTIONS = [
  { id: 'cuisine-cards', category: 'cuisine' },
  { id: 'shopping-cards', category: 'shopping' },
  { id: 'attractions-cards', category: 'attractions' },
  { id: 'accomodation-cards', category: 'accomodation' },
  { id: 'entertainment-cards', category: 'entertainment' },
  { id: 'transport-cards', category: 'transport' },
  { id: 'services-cards', category: 'services' },
  { id: 'religion-cards', category: 'religion' }
];
  fetch('/api/places')
  .then(resp => resp.json())
  .then(data => {
    SECTIONS.forEach(section => {
      const container = document.getElementById(section.id);
      const items = data.filter(place =>
        Array.isArray(place.category)
          ? place.category.includes(section.category)
          : place.category === section.category
      );
      items.sort(() => Math.random() - 0.5);
      // Render up to 6 places
      items.slice(0, 6).forEach(place => {
        const slug = slugify(place.name);
        const card = document.createElement('div');
        card.className = 'card';
        card.style.cursor = 'pointer';
        card.innerHTML = `
          <img src="${place.photo || '/static/images/default.jpg'}" alt="${place.name}">
          <div class="banner">${place.name}</div>
          <div class="description">${place.description}</div>
        `;
        card.addEventListener('click', () => {
          window.location.href = '/place_detail/' + slug;
        });
        container.appendChild(card);
      });
      // Add More button if there are more than 6
      if (items.length > 6) {
        const moreBtn = document.createElement('div');
        moreBtn.className = 'card more-card';
        moreBtn.textContent = "More";
        moreBtn.style.cursor = "pointer";
        moreBtn.addEventListener('click', () => {
          window.location.href = FLASK_ROUTES[section.category];
        });
        container.appendChild(moreBtn);
      }
    });
  });

  // === Floating Button & Window (Robust) ===
  const btn = document.getElementById('chatbot-float-btn');
  const win = document.getElementById('chatbot-window');
  const minGap = 24; // Minimum px from any edge
  let dragging = false, offsetX = 0, offsetY = 0, movedDuringDrag = false;

  // --- Utility ---
  function clamp(val, min, max) { return Math.max(min, Math.min(val, max)); }
  function snapToEdge(x, y) {
    // Find nearest edge, but always leave minGap (and btn size) away
    const btnW = btn.offsetWidth, btnH = btn.offsetHeight;
    const viewportW = window.innerWidth, viewportH = window.innerHeight;
    const dLeft = x, dRight = viewportW - (x + btnW),
          dTop = y, dBottom = viewportH - (y + btnH);
    const minDist = Math.min(dLeft, dRight, dTop, dBottom);
    let edge;
    if (minDist === dLeft) edge = 'left';
    else if (minDist === dRight) edge = 'right';
    else if (minDist === dTop) edge = 'top';
    else edge = 'bottom';

    // Clamp the button position so it never goes too close to any edge
    let finalX = x, finalY = y;
    if (edge === 'left' || edge === 'right') {
      finalY = clamp(y, minGap, viewportH - btnH - minGap);
      finalX = (edge === 'left') ? minGap : viewportW - btnW - minGap;
    } else {
      finalX = clamp(x, minGap, viewportW - btnW - minGap);
      finalY = (edge === 'top') ? minGap : viewportH - btnH - minGap;
    }
    return { edge, finalX, finalY };
  }
  function setBtnPos(edge, x, y) {
    btn.style.left = ''; btn.style.right = ''; btn.style.top = ''; btn.style.bottom = '';
    if (edge === 'left')      { btn.style.left = minGap + 'px'; btn.style.top = y + 'px'; }
    else if (edge === 'right'){ btn.style.right = minGap + 'px'; btn.style.top = y + 'px'; }
    else if (edge === 'top')  { btn.style.top = minGap + 'px'; btn.style.left = x + 'px'; }
    else if (edge === 'bottom'){btn.style.bottom = minGap + 'px'; btn.style.left = x + 'px'; }
  }
  function setWinPos(edge, x, y) {
    win.style.left = ''; win.style.right = ''; win.style.top = ''; win.style.bottom = '';
    // Always stay fully on screen with minGap (even if window is big)
    const w = win.offsetWidth, h = win.offsetHeight;
    const btnW = btn.offsetWidth, btnH = btn.offsetHeight;
    if (edge === 'left') {
      win.style.left = (minGap * 2 + btnW) + 'px';
      win.style.top = y + 'px';
      if (parseInt(win.style.top) + h > window.innerHeight - minGap)
        win.style.top = (window.innerHeight - h - minGap) + 'px';
    } else if (edge === 'right') {
      win.style.right = (minGap * 2 + btnW) + 'px';
      win.style.top = y + 'px';
      if (parseInt(win.style.top) + h > window.innerHeight - minGap)
        win.style.top = (window.innerHeight - h - minGap) + 'px';
    } else if (edge === 'top') {
      win.style.top = (minGap * 2 + btnH) + 'px';
      win.style.left = x + 'px';
      if (parseInt(win.style.left) + w > window.innerWidth - minGap)
        win.style.left = (window.innerWidth - w - minGap) + 'px';
    } else if (edge === 'bottom') {
      win.style.bottom = (minGap * 2 + btnH) + 'px';
      win.style.left = x + 'px';
      if (parseInt(win.style.left) + w > window.innerWidth - minGap)
        win.style.left = (window.innerWidth - w - minGap) + 'px';
    }
  }

  // --- Drag/Drop Logic ---
  btn.addEventListener('mousedown', (e) => {
    dragging = true; movedDuringDrag = false;
    offsetX = e.clientX - btn.getBoundingClientRect().left;
    offsetY = e.clientY - btn.getBoundingClientRect().top;
    document.body.style.userSelect = "none";
  });
  document.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    movedDuringDrag = true;
    let x = e.clientX - offsetX;
    let y = e.clientY - offsetY;
    // Clamp so button stays fully visible
    x = clamp(x, minGap, window.innerWidth - btn.offsetWidth - minGap);
    y = clamp(y, minGap, window.innerHeight - btn.offsetHeight - minGap);
    btn.style.left = x + "px"; btn.style.top = y + "px";
    btn.style.right = ""; btn.style.bottom = "";
  });
  document.addEventListener('mouseup', (e) => {
    if (!dragging) return;
    dragging = false; document.body.style.userSelect = "";
    let x = btn.getBoundingClientRect().left, y = btn.getBoundingClientRect().top;
    const { edge, finalX, finalY } = snapToEdge(x, y);
    setBtnPos(edge, finalX, finalY);
    setWinPos(edge, finalX, finalY);
  });
  btn.addEventListener('click', function(e) {
    if (movedDuringDrag) { movedDuringDrag = false; return; }
    toggleChatbotWindow();
  });
  // On load: snap to bottom right
  setBtnPos('right', window.innerWidth - btn.offsetWidth - minGap, window.innerHeight - btn.offsetHeight - minGap);
  setWinPos('right', window.innerWidth - btn.offsetWidth - minGap, window.innerHeight - btn.offsetHeight - minGap);

  // --- Chatbot Toggle ---
  let widgetOpen = false;
  function toggleChatbotWindow() {
    widgetOpen = !widgetOpen;
    win.style.display = widgetOpen ? "flex" : "none";
    if (widgetOpen) {
      // Align window to current snapped edge/position of button
      let btnRect = btn.getBoundingClientRect();
      let { edge, finalX, finalY } = snapToEdge(btnRect.left, btnRect.top);
      setWinPos(edge, finalX, finalY);
    }
  }
    // --- Chat history and chat logic ---
    function widgetSaveHistory() {
      const chatMessages = document.getElementById('chatbot-messages-widget');
      const msgs = [];
      chatMessages.querySelectorAll('.message-row').forEach(row => {
        const sender = row.classList.contains('self') ? 'self' : 'assistant';
        const text = row.querySelector('.chat-bubble').textContent;
        msgs.push({ sender, text });
      });
      localStorage.setItem(WIDGET_CHAT_KEY, JSON.stringify(msgs));
    }
    function widgetRestoreHistory() {
      const chatMessages = document.getElementById('chatbot-messages-widget');
      chatMessages.innerHTML = "";
      const msgs = JSON.parse(localStorage.getItem(WIDGET_CHAT_KEY) || "[]");
      msgs.forEach(m => widgetAddMessage(m.text, m.sender, false));
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function widgetClearChatHistory() {
      document.getElementById('chatbot-messages-widget').innerHTML = "";
      localStorage.removeItem(WIDGET_CHAT_KEY);
    }
    function confirmClearChat() {
      if (window.confirm("Are you sure you want to clear all chat history? This cannot be undone.")) {
        widgetClearChatHistory();
      }
    }
    function widgetAddMessage(text, sender, save = true) {
      const chatMessages = document.getElementById('chatbot-messages-widget');
      const msgRow = document.createElement('div');
      msgRow.className = 'message-row ' + sender;
      const img = document.createElement('img');
      img.className = 'profile-pic';
      img.src = sender === "self"
        ? "{{ url_for('static', filename='images/self.png') }}"
        : "{{ url_for('static', filename='images/chatbot.png') }}";
      img.alt = sender === "self" ? "You" : "Assistant";
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble';
      bubble.textContent = text;
      if (sender === "self") {
        msgRow.appendChild(bubble);
        msgRow.appendChild(img);
      } else {
        msgRow.appendChild(img);
        msgRow.appendChild(bubble);
      }
      chatMessages.appendChild(msgRow);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      if (save) widgetSaveHistory();
    }
    function widgetFetchAssistantReply(userMsg) {
      widgetAddMessage("...", "assistant");
      fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: userMsg })
      })
      .then(response => response.json())
      .then(data => {
        const chatMessages = document.getElementById('chatbot-messages-widget');
        chatMessages.removeChild(chatMessages.lastChild);
        widgetAddMessage(data.reply, "assistant");
      })
      .catch(error => {
        const chatMessages = document.getElementById('chatbot-messages-widget');
        chatMessages.removeChild(chatMessages.lastChild);
        widgetAddMessage("[Error contacting assistant. Try again later.]", "assistant");
        console.error(error);
      });
    }
    function sendWidgetMessage() {
      const input = document.getElementById('widget-msg');
      const msg = input.value.trim();
      if (msg.length) {
        widgetAddMessage(msg, "self");
        input.value = '';
        widgetFetchAssistantReply(msg);
      }
      return false;
    }
    widgetRestoreHistory();
    // Helper for window positioning
    function setWindowPosition(edge, x, y) {
      const btn = document.getElementById('chatbot-float-btn');
      const win = document.getElementById('chatbot-window');
      win.style.left = ''; win.style.right = ''; win.style.top = ''; win.style.bottom = '';
      if (edge === 'left') {
        win.style.left = (24 + btn.offsetWidth + 14) + 'px';
        win.style.top = y + 'px';
      } else if (edge === 'right') {
        win.style.right = (24 + btn.offsetWidth + 14) + 'px';
        win.style.top = y + 'px';
      } else if (edge === 'top') {
        win.style.top = (24 + btn.offsetHeight + 14) + 'px';
        win.style.left = x + 'px';
      } else if (edge === 'bottom') {
        win.style.bottom = (24 + btn.offsetHeight + 14) + 'px';
        win.style.left = x + 'px';
      }
    }
  </script>
</body>
</html>

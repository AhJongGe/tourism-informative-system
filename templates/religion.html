<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Religion | Tourism Malaysia</title>
  <style>
    body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background: #fafbff; color: #222;
    }
    .navbar {
      display: flex; align-items: center; justify-content: space-between;
      height: 54px; background: #fff; border-bottom: 1px solid #eee;
      padding: 0 16px; position: sticky; top: 0; z-index: 99;
    }
    .return-btn, .filter-btn {
      background: none; border: none; padding: 8px; cursor: pointer;
      display: flex; align-items: center;
    }
    .return-btn img, .filter-btn img { height: 28px; }
    .search-bar-container {
      display: flex; align-items: center;
      flex: 1 1 240px; max-width: 380px; margin: 0 22px;
      background: #f3f3f3; border-radius: 18px; padding-left: 12px;
    }
    .search-bar-container .search-icon {
      width: 22px; margin-right: 8px;
    }
    #main-search {
      border: none; outline: none;
      width: 100%; font-size: 1rem;
      background: transparent; padding: 10px 0;
    }
    /* Megamenu */
    .megamenu {
      display: none;
      position: fixed;
      top: 62px; /* below navbar */
      right: 16px;
      width: 40vw; min-width: 310px; max-width: 420px;
      max-height: 80vh; overflow-y: auto;
      background: #fff; box-shadow: 0 8px 32px rgba(0,0,0,0.16);
      border-radius: 14px; z-index: 1001;
      padding: 18px 16px 22px 16px;
    }
    .megamenu-search {
      display: flex; align-items: center; margin-bottom: 12px;
      background: #f3f3f3; border-radius: 18px; padding-left: 12px;
    }
    .megamenu-search .search-icon {
      width: 18px; margin-right: 7px;
    }
    #label-search {
      border: none; outline: none;
      width: 100%; background: transparent; padding: 8px 0;
    }
    .chosen-labels {
      display: flex; flex-wrap: wrap; gap: 10px;
      margin-bottom: 10px;
    }
    .all-labels {
      display: flex; flex-wrap: wrap; gap: 10px;
    }
    .label-btn {
      display: flex; align-items: center; border-radius: 20px;
      border: 2px solid #003087; color: #222; background: #fff;
      padding: 7px 16px 7px 8px; min-width: 86px; max-width: 148px;
      overflow: hidden; cursor: pointer; position: relative;
      transition: background 0.12s, color 0.12s, filter 0.13s;
    }
    .label-btn img { width: 20px; margin-right: 8px; }
    .label-btn.chosen {
      background: #003087; color: #fff;
    }
    .label-btn:hover {
      filter: brightness(1.5);
    }
    .label-btn .scroll-text {
      display: inline-block; white-space: nowrap; transition: transform 0.6s linear;
      max-width: 90px;
    }
    .label-section {
      margin-bottom: 28px; /* space between sections */
    }

    .label-section-title {
      font-weight: bold;
      font-size: 1.13em;
      color: #003087;
      margin-bottom: 7px;  /* space below title */
      margin-top: 0;
    }

    .label-section-labels {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px; /* row and column gaps between buttons */
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .card-container {
      display: flex; flex-wrap: wrap; gap: 20px;
      justify-content: center; padding: 30px 5vw 10px 5vw; min-height: 160px;
    }
    .card-link { text-decoration: none; color: inherit; }

    .card {
      background: #fff; border-radius: 18px;
      width: 260px; max-width: 98vw; height: 340px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      display: flex; flex-direction: column;
      cursor: pointer; overflow: hidden;
      transition: box-shadow 0.17s, transform 0.13s;
      margin-bottom: 12px;
    }
    .card:hover {
      box-shadow: 0 6px 24px rgba(0,0,0,0.15);
      transform: translateY(-2px) scale(1.01);
    }
    .card-img {
      flex: 1 1 50%;
      width: 100%; height: 50%;
      object-fit: cover; background: #ddd;
      min-height: 0; max-height: 50%;
    }
    .card-info {
      flex: 1 1 50%;
      background: #fff;
      padding: 14px 16px 10px 16px;
      display: flex; flex-direction: column;
      justify-content: flex-start;
      font-size: 0.96rem;
      height: 50%; min-height: 0;
    }
    .card-info-row {
      white-space: nowrap;
      overflow: visible;
      text-overflow: ellipsis;
      height: 1.6em;
      margin-bottom: 3px;
      display: block;
    }

    .card-labels {
      color: #003087;
      font-size: 0.93em;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card-label-section {
      margin-bottom: 4px;
      font-size: 0.93em;
      white-space: normal;
    }
    .card-label-section-title {
      font-weight: bold;
      color: #003087;
      margin-right: 4px;
    }
    .card-label-section-labels {
      color: #444;
    }
    .end-marker {
      color: #aaa; text-align: center; margin: 36px 0 18px 0;
      font-size: 1.18rem; letter-spacing: 1px; user-select: none;
    }
    @media (max-width: 700px) {
      .navbar { flex-direction: column; height: auto; }
      .search-bar-container { margin: 10px 0; width: 98vw; max-width: none;}
      .megamenu { width: 98vw; right: 1vw; }
      .card { width: 94vw; min-width: 88vw; }
    }

    .card-status-open { color: #1bbb30; font-weight: bold; }
    .card-status-closed { color: #e43939; font-weight: bold; }
    .card-status-closing { color: #ff9800; font-weight: bold; }
    .card-status-opening { color: #99ff00; font-weight: bold; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <button class="return-btn" onclick="window.history.back()">
      <img src="static/images/return.png" alt="Return">
    </button>
    <div class="search-bar-container">
      <img src="static/images/search.png" class="search-icon">
      <input type="text" id="main-search" placeholder="Search religion..." autocomplete="off">
    </div>
    <button class="filter-btn" id="filterBtn">
      <img src="static/images/filter.png" alt="Filter">
    </button>
  </div>
  <!-- Megamenu Filter -->
  <div class="megamenu" id="megamenu">
    <div class="megamenu-search">
      <img src="static/images/search.png" class="search-icon">
      <input type="text" id="label-search" placeholder="Search labels..." autocomplete="off">
    </div>
    <div class="chosen-labels" id="chosen-labels"></div>
    <div class="all-labels" id="all-labels"></div>
  </div>
  <!-- Cards -->
  <div class="card-container" id="card-container"></div>
  <div class="end-marker">--------------- Â· ---------------</div>

<!-- Day.js and timezone plugins -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
<script>
function slugify(str) {
  return str
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '') // Remove non-alphanumeric except space and hyphen
    .replace(/\s+/g, '-')         // Replace spaces with hyphens
    .replace(/-+/g, '-')          // Collapse multiple hyphens
    .replace(/^-+|-+$/g, '');     // Trim hyphens from start/end
}

dayjs.extend(dayjs_plugin_utc);
dayjs.extend(dayjs_plugin_timezone);

function getOpenStatus(hoursObj) {
  const days = ['sun','mon','tue','wed','thu','fri','sat'];
  const now = dayjs().tz('Asia/Kuching');
  const day = days[now.day()];
  const todayHours = hoursObj ? hoursObj[day] : null;

  if (!todayHours || todayHours.toLowerCase() === 'closed') {
    return { status: 'closed', label: 'Currently Closed', class: 'card-status-closed' };
  }
  const [openStr, closeStr] = todayHours.split('-');
  if (!openStr || !closeStr) return { status: 'closed', label: 'Currently Closed', class: 'card-status-closed' };

  const [openH, openM] = openStr.split(':').map(Number);
  const [closeH, closeM] = closeStr.split(':').map(Number);

  let openTime = now.hour(openH).minute(openM).second(0);
  let closeTime = now.hour(closeH).minute(closeM).second(0);

  // Handle after-midnight closing
  if (closeTime.isBefore(openTime)) closeTime = closeTime.add(1, 'day');

  if (now.isBefore(openTime)) {
    const diff = openTime.diff(now, 'minute');
    if (diff < 60) return { status: 'opensoon', label: `Opens in ${diff} min`, class: 'card-status-opening' };
    return { status: 'closed', label: 'Currently Closed', class: 'card-status-closed' };
  }
  if (now.isAfter(openTime) && now.isBefore(closeTime)) {
    const diff = closeTime.diff(now, 'minute');
    if (diff < 60) return { status: 'closingsoon', label: `Closes in ${diff} min`, class: 'card-status-closing' };
    return { status: 'open', label: 'Currently Open', class: 'card-status-open' };
  }
  return { status: 'closed', label: 'Currently Closed', class: 'card-status-closed' };
}
</script>

<script>
let placesData = [];
let sectionTags = {};
let activeTags = [];
let labelSearchTerm = '';
let cardSearchTerm = '';
const labelIcons = {};

function debounce(func, delay) {
  let timer;
  return function(...args) {
    clearTimeout(timer);
    timer = setTimeout(() => func.apply(this, args), delay);
  };
}

fetch('/api/places')
  .then(resp => resp.json())
  .then(data => {
    placesData = data.filter(place => {
      if (!place.category) return false;
      if (Array.isArray(place.category)) {
        return place.category.includes('religion');
      } else {
        return place.category === 'religion';
      }
    });

    sectionTags = {};
    placesData.forEach(place => {
      if (!place.religion_tags) return;
      Object.entries(place.religion_tags).forEach(([section, tags]) => {
        if (!sectionTags[section]) sectionTags[section] = new Set();
        tags.forEach(tag => sectionTags[section].add(tag));
      });
    });

    renderLabels();
    renderCards();
  });

function truncateText(text, maxLen) {
  if (!text) return '';
  if (text.length <= maxLen) return text;
  let cut = text.lastIndexOf(',', maxLen-5);
  if (cut < 0) cut = maxLen-5;
  return text.slice(0, cut) + '.....';
}

function renderCards() {
  const container = document.getElementById('card-container');
  let filtered = placesData.filter(place =>
    (activeTags.length === 0 ||
      activeTags.every(tag =>
        Object.values(place.religion_tags || {}).some(tagArr => tagArr.includes(tag))
      )
    ) &&
    (
      cardSearchTerm === '' ||
      (place.name && place.name.toLowerCase().includes(cardSearchTerm)) ||
      (place.description && place.description.toLowerCase().includes(cardSearchTerm)) ||
      Object.values(place.religion_tags || {}).some(tagArr => tagArr.some(t => t.toLowerCase().includes(cardSearchTerm)))
    )
  );
  container.innerHTML = '';
  if (filtered.length === 0) {
    container.innerHTML = '<div style="margin:40px auto;font-size:1.2em;color:#aaa;text-align:center;">No matches found.</div>';
    return;
  }
  filtered.forEach(place => {
    const name = place.name ? truncateText(place.name, 32) : '';
    const description = place.description ? truncateText(place.description, 48) : '';
    let timeAvail = '-';
    if (place.hours) {
      const days = ['sun','mon','tue','wed','thu','fri','sat'];
      const now = dayjs().tz('Asia/Kuching');
      const dayKey = days[now.day()];
      const todayHours = place.hours[dayKey];
      if (todayHours && todayHours.toLowerCase() !== 'closed') {
        timeAvail = todayHours;
      } else {
        timeAvail = 'Closed today';
      }
    }

    // Calculate status object
    let openStatus = { label: '', class: '' };
    if (place.hours) openStatus = getOpenStatus(place.hours);

    let labelSections = '';
    if (place.religion_tags) {
      Object.entries(place.religion_tags).forEach(([section, tags]) => {
        if (!tags.length) return;
        let sectionTitle = section.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        labelSections += `<div class="card-label-section">
          <span class="card-label-section-title">${sectionTitle}:</span>
          <span class="card-label-section-labels">${tags.join(', ')}</span>
        </div>`;
      });
    }
    container.innerHTML += `
        <a href="/place_detail/${slugify(place.name)}" class="card-link" title="View details">
          <div class="card">
            <img src="${place.photo || 'static/images/default.jpg'}" class="card-img" alt="${name}">
            <div class="card-info">
              <div class="card-info-row"><b>Name:</b> ${name}</div>
              <div class="card-info-row"><b>Description:</b> ${description}</div>
              <div class="card-info-row"><b>Time available:</b> ${timeAvail}</div>
              <div class="card-info-row"><span class="${openStatus.class}">${openStatus.label}</span></div>
              <div class="card-labels">${labelSections}</div>
            </div>
          </div>
        </a>
      `;
  });
}

// Render label buttons in megamenu
function renderLabels() {
  const chosen = document.getElementById('chosen-labels');
  chosen.innerHTML = '';
  activeTags.forEach(tag => {
    chosen.innerHTML += `
      <div class="label-btn chosen" data-tag="${tag}" onclick="toggleTag('${tag}')">
        <img src="${labelIcons[tag] || 'static/images/label.png'}" alt="">
        <span class="scroll-text">${tag}</span>
      </div>
    `;
  });

  const all = document.getElementById('all-labels');
  all.innerHTML = '';

  // For each section in sectionTags, display the section and its tags
  Object.entries(sectionTags).forEach(([section, tagSet]) => {
    // Optionally filter by search term
    const filtered = Array.from(tagSet).filter(tag =>
      !activeTags.includes(tag) &&
      (!labelSearchTerm || tag.toLowerCase().includes(labelSearchTerm))
    );
    if (!filtered.length) return;

    // Make a human-friendly section title
    let sectionTitle = section.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    all.innerHTML += `
  <div class="label-section">
    <div class="label-section-title">${sectionTitle}</div>
    <div class="label-section-labels">
      ${filtered.map(tag => `
        <div class="label-btn" data-tag="${tag}" onclick="toggleTag('${tag}')">
          <span class="scroll-text">${tag}</span>
        </div>
      `).join('')}
    </div>
  </div>
`;
  });
  setTimeout(attachLabelScrollers, 200); // For label animation
}

// Toggle tag selection
window.toggleTag = function(tag) {
  if (activeTags.includes(tag)) {
    activeTags = activeTags.filter(t => t !== tag);
  } else {
    activeTags.push(tag);
  }
  renderLabels();
  renderCards();
}

// Search bar in main navbar (debounced 100ms)
document.getElementById('main-search').addEventListener('input',
  debounce(function(e) {
    cardSearchTerm = e.target.value.trim().toLowerCase();
    renderCards();
  }, 100)
);

// Label search in megamenu (debounced 100ms)
document.getElementById('label-search').addEventListener('input',
  debounce(function(e) {
    labelSearchTerm = e.target.value.trim().toLowerCase();
    renderLabels();
  }, 100)
);

// Filter button: show/hide megamenu
const megamenu = document.getElementById('megamenu');
const filterBtn = document.getElementById('filterBtn');

filterBtn.addEventListener('click', function(e) {
  megamenu.style.display = 'block';
  renderLabels(); // If not already called as part of showing the filter
  attachLabelScrollers();
  e.stopPropagation();
});

document.addEventListener('click', function(e) {
  if (!megamenu.contains(e.target) && e.target !== filterBtn) {
    megamenu.style.display = 'none';
  }
});

megamenu.addEventListener('click', function(e) {
  e.stopPropagation(); // don't close if clicking inside
});

// Animated label scroll (minimal version)
function attachLabelScrollers() {
  document.querySelectorAll('.label-btn').forEach(btn => {
    if (btn._scrollStop) btn._scrollStop();
  });
  document.querySelectorAll('.label-btn .scroll-text').forEach(span => {
    const btn = span.parentElement;
    const available = btn.offsetWidth - 34; // adjust if you removed icons, just use btn.offsetWidth

    // Reset state
    span.style.transform = `translateX(0px)`;
    span.style.transition = "none";

    // Only animate if text is overflowing
    if (span.scrollWidth > available) {
      let maxScroll = span.scrollWidth - available;
      let running = true;

      function animateScroll() {
        if (!running) return;
        // Reset to start
        span.style.transition = "none";
        span.style.transform = `translateX(0px)`;

        // Wait 1.5s, then scroll left
        setTimeout(() => {
          if (!running) return;
          span.style.transition = "transform 3s linear"; // Adjust duration for your speed
          span.style.transform = `translateX(-${maxScroll}px)`;

          // Wait until scroll finishes, then pause 1s, then jump back and repeat
          setTimeout(() => {
            if (!running) return;
            span.style.transition = "none";
            span.style.transform = `translateX(-${maxScroll}px)`;
            setTimeout(() => {
              if (!running) return;
              animateScroll();
            }, 1000); // Pause at the end for 1s
          }, 3000); // 3s is the scroll duration; match to your transition above
        }, 1500); // Initial delay 1.5s
      }

      animateScroll();

      // Optional: Clean up on removal (if you're doing dynamic DOM updates)
      btn._scrollStop = () => { running = false; };
    }
  });
}

</script>
</body>
</html>
